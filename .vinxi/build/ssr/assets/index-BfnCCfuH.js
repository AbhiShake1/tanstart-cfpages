import{jsxs as N}from"react/jsx-runtime";import"node:stream";import{i as w,m as I,t as M,g as H,a as P,b as O,c as A,s as J,R as k,d as q}from"./ssr-DNqj_sga.js";import{defaultTransformer as f,isRedirect as v,isNotFound as m,isPlainObject as _,encode as U,useRouter as D}from"@tanstack/react-router";import{eventHandler as G}from"h3";import"node:async_hooks";import"react";import"react-dom/server";const L=[];function g(e,n){const t=n||e||{};return typeof t.method>"u"&&(t.method="GET"),{options:t,middleware:r=>g(void 0,Object.assign(t,{middleware:r})),validator:r=>g(void 0,Object.assign(t,{validator:r})),handler:(...r)=>{const[o,i]=r;Object.assign(t,{...o,extractedFn:o,serverFn:i}),w(o.url);const s=[...t.middleware||[],V(t)];return Object.assign(async c=>j(s,"client",{...o,method:t.method,data:c?.data,headers:c?.headers,context:{}}).then(a=>{if(a.error)throw a.error;return a.result}),{...o,__executeServer:async c=>{const a=c instanceof FormData?B(c):c;return await j(s,"server",{...o,...a}).then(d=>({result:d.result,error:d.error,context:d.sendContext}))}})}}}function B(e){const n=e.get("__TSR_CONTEXT");if(e.delete("__TSR_CONTEXT"),typeof n!="string")return{context:{},data:e};try{return{context:f.parse(n),data:e}}catch{return{data:e}}}function X(e){const n=new Set,t=[],r=o=>{o.forEach(i=>{i.options.middleware&&r(i.options.middleware),n.has(i)||(n.add(i),t.push(i))})};return r(e),t}const R=async(e,n,t)=>e({...n,next:async(r={})=>t({...n,...r,context:{...n.context,...r.context},sendContext:{...n.sendContext,...r.sendContext??{}},headers:I(n.headers,r.headers),result:r.result!==void 0?r.result:n.result,error:r.error??n.error})});function z(e,n){if(e==null)return{};if("~standard"in e){const t=e["~standard"].validate(n);if(t instanceof Promise)throw new Error("Async validation not supported");if(t.issues)throw new Error(JSON.stringify(t.issues,void 0,2));return t.value}if("parse"in e)return e.parse(n);if(typeof e=="function")return e(n);throw new Error("Invalid validator type!")}async function j(e,n,t){const r=X([...L,...e]),o=async i=>{const s=r.shift();if(!s)return i;s.options.validator&&(n!=="client"||s.options.validateClient)&&(i.data=await z(s.options.validator,i.data));const c=n==="client"?s.options.client:s.options.server;return c?R(c,i,async a=>{const p=s.options.clientAfter;if(n==="client"&&p){const d=await o(a);return R(p,{...a,...d},u=>u)}return o(a).catch(d=>{if(v(d)||m(d))return{...a,error:d};throw d})}):o(i)};return o({...t,headers:t.headers||{},sendContext:t.sendContext||{},context:t.context||{}})}function V(e){return{_types:void 0,options:{validator:e.validator,validateClient:e.validateClient,client:async({next:n,sendContext:t,...r})=>{var o;const i=await((o=e.extractedFn)==null?void 0:o.call(e,{...r,context:t}));return n(i)},server:async({next:n,...t})=>{var r;const o=await((r=e.serverFn)==null?void 0:r.call(e,t));return n({...t,result:o})}}}}async function W(e,n,t){var r;const o=n[0];if(_(o)&&o.method){const a=o,p=a.data instanceof FormData?"formData":"payload",d=new Headers({...p==="payload"?{"content-type":"application/json",accept:"application/json"}:{},...a.headers instanceof Headers?Object.fromEntries(a.headers.entries()):a.headers||{}});if(a.method==="GET"){const h=U({payload:f.stringify({data:a.data,context:a.context})});h&&(e+=`&${h}`)}const u=new Request(e,{method:a.method,headers:d,...K(a)}),l=await t(u),y=await T(l);if((r=y.headers.get("content-type"))!=null&&r.includes("application/json")){const h=f.decode(await y.json());if(v(h)||m(h)||h instanceof Error)throw h;return h}return y}const i=new Request(e,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)}),s=await T(await t(i)),c=s.headers.get("content-type");return c&&c.includes("application/json")?f.decode(await s.json()):s.text()}function K(e){return e.method==="POST"?e.data instanceof FormData?(e.data.set("__TSR_CONTEXT",f.stringify(e.context)),{body:e.data}):{body:f.stringify({data:e.data??null,context:e.context})}:{}}async function T(e){if(!e.ok){const n=e.headers.get("content-type");throw n&&n.includes("application/json")?f.decode(await e.json()):new Error(await e.text())}return e}function Q(e){return e.replace(/^\/|\/$/g,"")}function Y(e,n,t){return`${e}/${Q("/_server")}/?_serverFnId=${encodeURI(n)}&_serverFnName=${encodeURI(t)}`}G(Z);async function Z(e){return S(M(e))}async function S(e,n){var t,r;const o=e.method,i=new URL(e.url,"http://localhost:3000"),s=Object.fromEntries(i.searchParams.entries()),c=s._serverFnId,a=s._serverFnName;if(!c||!a)throw new Error("Invalid request");w(typeof c=="string");const p=(r=await((t=H("server").chunks[c])==null?void 0:t.import()))==null?void 0:r[a],d=await(async()=>{try{const u=await(async()=>{var y;if((y=e.headers.get("Content-Type"))!=null&&y.includes("multipart/form-data"))return w(o.toLowerCase()!=="get","GET requests with FormData payloads are not supported"),await e.formData();if(o.toLowerCase()==="get")return s.payload?f.parse(s.payload):void 0;const h=await e.text();return f.parse(h)})(),l=await p(u);return l instanceof Response?l:_(l)&&"result"in l&&l.result instanceof Response?l.result:v(l)||m(l)?x(l):new Response(l!==void 0?f.stringify(l):void 0,{status:P(O()),headers:{"Content-Type":"application/json"}})}catch(u){return u instanceof Response?u:_(u)&&"result"in u&&u.result instanceof Response?u.result:v(u)||m(u)?x(u):(console.error("Server Fn Error!"),console.error(u),console.info(),new Response(f.stringify(u),{status:500,headers:{"Content-Type":"application/json"}}))}})();if(d.headers.get("Content-Type")==="application/json"){const l=await d.clone().text();l&&JSON.stringify(JSON.parse(l))}return d}function x(e){const{headers:n,...t}=e;return new Response(JSON.stringify(t),{status:200,headers:{"Content-Type":"application/json",...n||{}}})}const F="http://localhost:3000";function C(e,n,t){const r=Y(F,n,t);return Object.assign((...i)=>(w(i.length===1),W(r,i,async s=>{const c=O(),a=A(c);return Object.entries(a).forEach(([p,d])=>{s.headers.has(p)||s.headers.append(p,d)}),S(s)})),{url:r.replace(F,""),filename:n,functionId:t})}async function E(){return parseInt(q("count")||"0")}const b=g({method:"GET"}).handler(C(ee,"c_uye90v","$$function0"),()=>E()),$=g({method:"POST"}).validator(e=>e).handler(C(te,"c_uye90v","$$function1"),async({data:e})=>{const n=await E();J("count",String(n+e))}),ue=function(){const n=D(),t=k.useLoaderData();return N("button",{type:"button",onClick:()=>{$({data:1}).then(()=>{n.invalidate()})},children:["Add 1 to ",t,"?"]})},le=()=>b();function ee(e){return b.__executeServer(e)}function te(e){return $.__executeServer(e)}export{ee as $$function0,te as $$function1,ue as component,le as loader};
